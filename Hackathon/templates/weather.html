<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Weather + Flood Prediction</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />

  <!-- âœ… Bootstrap -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet" />
  <!-- âœ… Chart.js -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <!-- âœ… Leaflet -->
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
  <!-- âœ… Custom Styles -->
  <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}">
</head>

<body class="bg-light">

    <nav class="topbar">
        <div class="topbar-left">ğŸŒ¦ï¸ FloodAware</div>
        <div class="topbar-links">
          <a href="/">Home</a>
          <a href="/evacuation-plan">Evacuation Plan</a>
          <a href="/volunteer">Volunteer / Request Aid</a>
          <a href="/ask">Ask FloodBot</a>
        </div>
      </nav>      

  <!-- âœ… Main Container -->
  <div class="container my-5 p-4 bg-white rounded-4 shadow fade-in">
    <h1 class="text-center text-primary mb-4">ğŸŒ§ï¸ Weather + Flood Risk AI</h1>

    <form method="POST" action="/weather" class="mb-4">
      <div class="row g-3 justify-content-center">
        <div class="col-md-6">
          <label for="location" class="form-label fw-semibold">Select Sarawak District:</label>
          <select class="form-select" name="location" id="location">
            {% for district in district_list %}
              <option value="{{ district }}" {% if query == district %}selected{% endif %}>{{ district }}</option>
            {% endfor %}
          </select>
        </div>
        <input type="hidden" name="alert_level" value="3.5">
        <input type="hidden" name="danger_level" value="4.2">
        <div class="col-md-2 d-flex align-items-end">
          <button type="submit" class="btn btn-primary w-100">Check</button>
        </div>
      </div>
    </form>

    {% if danger_alert %}
<p class="flood-risk">
  <span class="danger">ğŸš¨ Water Level has exceeded the Danger Level! Authorities have been notified.</span>
</p>
{% endif %}

    {% if query %}
    <!-- âœ… Results Section -->
    <div class="p-4 bg-light rounded border slide-in">
      <h5 class="mb-3 fw-bold">ğŸ“ Report for <span class="text-primary">{{ query }}</span></h5>
      <ul class="list-group mb-3">
        <li class="list-group-item">ğŸ“… Date: <strong>{{ date }}</strong></li>
        <li class="list-group-item">â˜ï¸ Condition: <strong>{{ condition }}</strong></li>
        <li class="list-group-item">ğŸŒ§ï¸ Rainfall: <strong>{{ rainfall }} mm</strong></li>
        <li class="list-group-item">ğŸŒŠ Water Level: <strong>{{ water_level }} m</strong></li>
        <li class="list-group-item">ğŸš¨ Alert Level: <strong>{{ alert_level }}</strong></li>
        <li class="list-group-item">ğŸ”´ Danger Level: <strong>{{ danger_level }}</strong></li>
      </ul>

      <!-- âœ… Manual Rule-Based Water Level Status -->
      <p class="flood-risk">
        <strong>âš ï¸ Water Level Status:</strong>
        {% if water_level >= danger_level %}
          <span class="danger">ğŸ”´ Danger Level</span>
        {% elif water_level >= alert_level %}
          <span class="alert">ğŸŸ¡ Alert Level</span>
        {% else %}
          <span class="safe">ğŸŸ¢ Normal</span>
        {% endif %}
      </p>

      <!-- âœ… AI Flood Prediction Result -->
      <p class="flood-risk">
        <strong>ğŸ§  AI Prediction:</strong>
        {% if flood_risk %}
          <span class="danger">âš ï¸ High Risk of Flooding</span>
        {% else %}
          <span class="safe">âœ… Safe</span>
        {% endif %}
      </p>
    </div>
    {% endif %}

    {% if rain_chart %}
    <!-- ğŸ“Š Chart -->
    <h4 class="mt-5">ğŸ“Š 3-Day Rainfall Forecast</h4>
    <canvas id="rainChart" height="120"></canvas>
    <script>
      const rainLabels = {{ rain_chart | map(attribute="date") | list | tojson | safe }};
      const rainData = {{ rain_chart | map(attribute="rain") | list | tojson | safe }};

      const ctx = document.getElementById('rainChart').getContext('2d');
      new Chart(ctx, {
        type: 'bar',
        data: {
          labels: rainLabels,
          datasets: [{
            label: 'Rainfall (mm)',
            data: rainData,
            backgroundColor: 'rgba(0, 119, 182, 0.6)',
            borderColor: 'rgba(0, 119, 182, 1)',
            borderWidth: 1,
            borderRadius: 5
          }]
        },
        options: {
          scales: {
            y: {
              beginAtZero: true,
              title: { display: true, text: 'Rainfall (mm)' }
            }
          }
        }
      });
    </script>
    {% endif %}

    {% if lat and lng %}
    <!-- ğŸ—ºï¸ Map -->
    <h4 class="mt-5">ğŸ—ºï¸ Location Map</h4>
    <div id="map" class="rounded" style="height: 350px;"></div>
    <script>
      document.addEventListener("DOMContentLoaded", function () {
        const map = L.map('map').setView([{{ lat | default(1.55) }}, {{ lng | default(110.33) }}], 8);
        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
          maxZoom: 18
        }).addTo(map);
        const marker = L.marker([{{ lat }}, {{ lng }}]).addTo(map);
        marker.bindPopup("{{ query }}<br>{{ 'âš ï¸ High Flood Risk' if flood_risk else 'âœ… Safe' }}").openPopup();
      });
    </script>
    {% endif %}

    {% if error %}
      <p class="alert alert-danger mt-4">âš ï¸ Error: {{ error }}</p>
    {% endif %}
  </div>

  <!-- âœ… Bootstrap JS -->
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
</body>
</html>
